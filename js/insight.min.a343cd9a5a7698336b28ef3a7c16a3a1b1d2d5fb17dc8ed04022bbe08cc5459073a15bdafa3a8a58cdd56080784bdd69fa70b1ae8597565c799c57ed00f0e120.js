(function($,CONFIG){var $main=$('.ins-search');var $input=$main.find('.ins-search-input');var $wrapper=$main.find('.ins-section-wrapper');var $container=$main.find('.ins-section-container');$main.parent().remove('.ins-search');$('body').append($main);function section(title){return $('<section>').addClass('ins-section').append($('<header>').addClass('ins-section-header').text(title));}
function searchItem(icon,title,slug,preview,url){return $('<div>').addClass('ins-selectable').addClass('ins-search-item').append($('<header>').append($('<i>').addClass('icon').addClass('icon-'+icon)).append(title!=null&&title!=''?title:CONFIG.TRANSLATION['UNTITLED']).append(slug?$('<span>').addClass('ins-slug').text(slug):null)).append(preview?$('<p>').addClass('ins-search-preview').text(preview):null).attr('data-url',url);}
function sectionFactory(type,array){var sectionTitle;var $searchItems;if(array.length===0)return null;sectionTitle=CONFIG.TRANSLATION[type];switch(type){case 'POSTS':$searchItems=array.map(function(item){return searchItem('file',item.title,null,item.content.slice(0,150),item.uri);});break;case 'CATEGORIES':case 'TAGS':$searchItems=array.map(function(item){return searchItem(type==='CATEGORIES'?'folder':'tag',item.title,'',null,item.uri);});break;default:return null;}
return section(sectionTitle).append($searchItems);}
function parseKeywords(keywords){return keywords.split(' ').filter(function(keyword){return!!keyword;}).map(function(keyword){return keyword.toUpperCase();});}
function filter(keywords,obj,fields){var result=false;var keywordArray=parseKeywords(keywords);var containKeywords=keywordArray.filter(function(keyword){var containFields=fields.filter(function(field){if(!obj.hasOwnProperty(field))
return false;if(obj[field].toUpperCase().indexOf(keyword)>-1)
return true;});if(containFields.length>0)
return true;return false;});return containKeywords.length===keywordArray.length;}
function filterFactory(keywords){return{POST:function(obj){return filter(keywords,obj,['title','content']);},PAGE:function(obj){return filter(keywords,obj,['title','content']);},CATEGORY:function(obj){return filter(keywords,obj,['title']);},TAG:function(obj){return filter(keywords,obj,['title']);}};}
function weight(keywords,obj,fields,weights){var value=0;parseKeywords(keywords).forEach(function(keyword){var pattern=new RegExp(keyword,'img');fields.forEach(function(field,index){if(obj.hasOwnProperty(field)){var matches=obj[field].match(pattern);value+=matches?matches.length*weights[index]:0;}});});return value;}
function weightFactory(keywords){return{POST:function(obj){return weight(keywords,obj,['title','content'],[3,1]);},PAGE:function(obj){return weight(keywords,obj,['title','content'],[3,1]);},CATEGORY:function(obj){return weight(keywords,obj,['title'],[1]);},TAG:function(obj){return weight(keywords,obj,['title'],[1]);}};}
function search(json,keywords){var WEIGHTS=weightFactory(keywords);var FILTERS=filterFactory(keywords);var posts=json.posts;var tags=json.tags;var categories=json.categories;return{posts:posts.filter(FILTERS.POST).sort(function(a,b){return WEIGHTS.POST(b)-WEIGHTS.POST(a);}).slice(0,5),categories:categories.filter(FILTERS.CATEGORY).sort(function(a,b){return WEIGHTS.CATEGORY(b)-WEIGHTS.CATEGORY(a);}).slice(0,5),tags:tags.filter(FILTERS.TAG).sort(function(a,b){return WEIGHTS.TAG(b)-WEIGHTS.TAG(a);}).slice(0,5)};}
function searchResultToDOM(searchResult){$container.empty();for(var key in searchResult){$container.append(sectionFactory(key.toUpperCase(),searchResult[key]));}}
function scrollTo($item){if($item.length===0)return;var wrapperHeight=$wrapper[0].clientHeight;var itemTop=$item.position().top-$wrapper.scrollTop();var itemBottom=$item[0].clientHeight+$item.position().top;if(itemBottom>wrapperHeight+$wrapper.scrollTop()){$wrapper.scrollTop(itemBottom-$wrapper[0].clientHeight);}
if(itemTop<0){$wrapper.scrollTop($item.position().top);}}
function selectItemByDiff(value){var $items=$.makeArray($container.find('.ins-selectable'));var prevPosition=-1;$items.forEach(function(item,index){if($(item).hasClass('active')){prevPosition=index;return;}});var nextPosition=($items.length+prevPosition+value)%$items.length;$($items[prevPosition]).removeClass('active');$($items[nextPosition]).addClass('active');scrollTo($($items[nextPosition]));}
function gotoLink($item){if($item&&$item.length){location.href=$item.attr('data-url');}}
$.getJSON(CONFIG.CONTENT_URL,function(json){if(location.hash.trim()==='#ins-search'){$main.addClass('show');}
$input.on('input',function(){var keywords=$(this).val();searchResultToDOM(search(json,keywords));});$input.trigger('input');});$(document).on('click focus','.search-form-input',function(){$main.addClass('show');$main.find('.ins-search-input').focus();}).on('click','.ins-search-item',function(){gotoLink($(this));}).on('click','.ins-close',function(){$main.removeClass('show');}).on('keydown',function(e){if(!$main.hasClass('show'))return;switch(e.keyCode){case 27:$main.removeClass('show');break;case 38:selectItemByDiff(-1);break;case 40:selectItemByDiff(1);break;case 13:gotoLink($container.find('.ins-selectable.active').eq(0));break;}});})(jQuery,window.INSIGHT_CONFIG);